<!DOCTYPE HTML>
<html lang="en"> 

<head> 

   <title></title> 
   <script src="js/Scribl.min.js"></script>		
   <script src="js/jquery.min.js"></script>
   <script src="js/mColorPicker_min.js"></script>
   <!-- <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/> -->
   <link href='http://fonts.googleapis.com/css?family=Amaranth:bold' rel='stylesheet' type='text/css'>
   <!-- <link href='http://fonts.googleapis.com/css?family=Gruppo' rel='stylesheet' type='text/css'> -->
   <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.13.redmond.css" />
   <link rel="stylesheet" type="text/css" href="css/figure-builder.css" />
   
   <script src="js/jquery-ui.chase.min.js"></script>
   <script src="js/jsdas.0.1.6.min.js" ></script>
   <script src="js/fabric.js"></script> 
   <script src="js/Delicious_500.font.js"></script>   
    
    <script type="text/javascript">    
            var activeSeqs = 0;
    		   var mainChart;	  
    		   var selected = []; 
    		   var fabricCanvas;

    		   $(document).ready(function() {
               var canvas = document.getElementById('canvas');               
               canvas.width = getCanvasWidth();               

               document.getElementById('canvasList').width = getCanvasWidth()+15;               
              // alert(canvas.width);
               mainChart = new Scribl(canvas, getChartWidth());
               mainChart.glyph.onClick = function(feature) {selectFeature(feature); redraw();};
               mainChart.lanesSizes = 13;
               $("button").button(); 

               $("#scaleSlider").slider( { min: 3, max: 30, value: 15, slide: function(event, ui){ redraw('scaleSize') } });
               $("#scaleSlider").slider('disable');
          		$("#shapeSlider").slider( { min: 1, max: 20, value: 6, slide: function(event, ui){ redraw('featureShape') } });
          		$("#shapeSlider").slider('disable');
          		$("#trackSlider").slider( { min: 1, max: 200, value: 13, slide: function(event, ui){ redraw('laneSize') } });
          		$("#trackSlider").slider('disable');
               $('#color1').bind('colorpicked', function () { redraw('color1'); });
               $('#color2').bind('colorpicked', function () { redraw('color2'); });
               $('#scaleShow').bind('click', function () { redraw(); });
               $('#selectAll').bind('click', function () { selectAllFeatures(); redraw(); });
               $('#scriblAnnotation').bind('click', function (e) { 
                  var event = jQuery.Event("click");
                  event.clientX = e.clientX;
                  event.clientY = e.clientY;
                  $('#canvas').trigger(event) 
               });
               loadUrlQuery();            
    		   });

            function selectFeature(feature, selecting) {
               var index = $.inArray(feature, selected)
               
               // select if not already selected
               if ( (selecting == undefined && index == -1) || selecting ) {
                  // set options to selected
                  if (selected.length == 0){
                     $("#shapeSlider").slider('value', feature.getRoundness());
                  }
                  selected.push(feature)
                  feature.borderColor = 'red';
               } else { // deselect if already selected
                  selected.splice(index, 1);
                  feature.borderColor = 'none';
               }
            }

            function draw() {
               mainChart.canvas.width = getCanvasWidth();
               mainChart.laneSizes = 13;
               mainChart.canvas.height = mainChart.getHeight();
               document.getElementById('canvasList').width = getCanvasWidth()+15;
               mainChart.draw();
               var img = mainChart.canvas.toDataURL("image/png");
               // Add link to download image
               // $("#export-image").attr('href', img);
               // $("#export-image").attr('target', '_blank');
            }
       		function getDas(name, source, chromosome, type, min, max, display) {
    
       				// get DAS data
       				var url = source + '/features?segment=' + chromosome + ':' + min + "," + max + ';type=' + type;   				
       				if(display == "Expand")
       				   JSDAS.features(url, function(response) { addFeatures(response, "Expand") });
       				else
       				   JSDAS.features(url, function(response) { addFeatures(response, "Collapse") });

            }  
             
            function exportImage() {
               var canvas = document.createElement('canvas'); 
               var ctx = canvas.getContext("2d");
               
               var chartCanvas = document.getElementById('canvas');
               var annotationCanvas = document.getElementById('scriblAnnotation');
               canvas.width =annotationCanvas.width;
               if (chartCanvas.height > annotationCanvas.height)
                  canvas.height =chartCanvas.height; 
               else 
                  canvas.height =annotationCanvas.height; 
               
               
                ctx.drawImage(chartCanvas, 0,0);
                fabricCanvas.renderAll(true);
                ctx.drawImage(fabricCanvas.upperCanvasEl, 0,0);
               var img = canvas.toDataURL('png');
               window.open(img);
            }

    		   function addFeatures(response, display) {
    		      // set width again in case window wasn't loaded completely
               mainChart.width = getChartWidth();
               var track;
               if (display == 'Expand')
                  track = mainChart.addTrack();
               else
                  track = mainChart.addTrack().addLane();

    				var features = response.GFF.SEGMENT[0].FEATURE;
                if (!features) {
                   // TODO add an error fetching message
                   return; 
                }
               features.sort( function(a,b){ return(parseInt(a.START.textContent) - parseInt(b.START.textContent)); });
    				for (var i=0; i < features.length; i++) {
    					var f = features[i];
    					var start = parseInt(f.START.textContent);
    					var length =  parseInt(f.END.textContent) - start;
    					if (f.ORIENTATION) {
    						orientation =  f.ORIENTATION.textContent;
    						var glyph = track.addGene(start, length, orientation);
    					} else
    						var glyph = track.addFeature( new Rect( "rect", start, length) );
                     
    					if (f.TYPE.textContent) glyph.name = f.TYPE.textContent;
    					if(f.LINK && f.LINK[0] && f.LINK[0].href) { 
    						//glyph.onMouseover = f.TYPE.textContent + "\n" + f.LINK[0].textContent || f.LINK[0].href;
    						//glyph.onClick = f.LINK[0].href.replace(":8080", "");
    					}
    				}
    				
    				activeSeqs--;
    				if(activeSeqs == 0)
    				   draw();

    			}
    
             
             function redraw(option) {
    				// changeable options    				
    				var roundness = $("#shapeSlider").slider( "option", "value" );
    				var laneSizes = $("#trackSlider").slider( "option", "value" );
    				var scaleSize = $("#scaleSlider").slider( "option", "value" );
    				var canvas = document.getElementById('canvas');
    				canvas.height = mainChart.getHeight() + 20;
    				
               if(!$('#scaleShow').attr('checked'))
    				   mainChart.scale.off = true;
    				else
                  mainChart.scale.off = false;    				

            	// assemble color
    				top_color = $('#color1').val();
    				bottom_color = $('#color2').val();
               
               //  set new chart values
               mainChart.laneSizes = parseInt(laneSizes);
               mainChart.scale.font.size = scaleSize;
               
               // apply changed to selected features if any
               // if (selected.length > 0) {
               //    var l = 1;
                  $.each(selected, function(index, feature) { if (option == 'featureShape') feature.roundness = roundness;});
                  $.each(selected, function(index, feature) { 
                     if (option == 'color1' || option == 'color2')
                        feature.setColorGradient(top_color, bottom_color);
                  });
                  //                }
                  //                else { // apply to all features if none selected
                  // // set glyph values
                  // mainChart.glyph.roundness = roundness;
                  //                   mainChart.gene.linearGradient = [top_color, bottom_color];
                  //                }

    				mainChart.redraw();

    				// Create image of mainChart1
               var img = mainChart.canvas.toDataURL("image/png");
               // Add link to download image
               // $("#export-image").attr('href', img);
               // $("#export-image").attr('target', '_blank');
    			}

             function getCanvasWidth(){return($(window).width() * .60);}
             function getChartWidth(){return ($(window).width() * .60 - 46); }
             
             // function jump() {
             //    var jumpTo = parseInt($('#jump').val());
             //    var range = parseInt($('#slider-range').slider('values',1) - $('#slider-range').slider('values',0));
             //    var min = jumpTo - range/2;
             //    var max = jumpTo + range/2;
             //    slideMin = min - bufferSize;
             //    slideMax = max + bufferSize;
             //    $( "#slider-range" ).slider('option', 'max', slideMax);
             //    $( "#slider-range" ).slider('option', 'min', slideMin);
             //    redraw(min, max, true);
             // }             
             
             function getUrlQuerys(){
                // get the current URL
                 var url = window.location.toString();
                 url = url.replace('#', '');
                 //get the parameters
                 url.match(/\?(.+)$/);
                 var params = RegExp.$1;
                 // split up the query string and store in an
                 // associative array
                 var params = params.split("&");
                 var queryStringList = {};

                 for(var i=0;i<params.length;i++) {
                     var tmp = params[i].split("=");
                     queryStringList[tmp[0]] = unescape(tmp[1]);
                 }
                 return (queryStringList);
             }
             
             function serializeToIframe() {
                var iframeStr = '<iframe width="500" height="315" style="border:1px solid rgb(220,220,220); border-radius: 4px" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="';
                iframeStr += serializeToUrl();
                iframeStr += '&embed=true"'
                iframeStr += '></iframe>';
                iframeStr += '<br/><small>Powered by <a href="http://chmille4.github.com/Scribl" style="color:#0000FF;text-align:left">Scribl</a></small>';
                return iframeStr;
             }
             
             function serializeToUrl() {
                var checkboxes = $('#source-list').find('input');
                                
                // get urls
                var sourceUrls = [];
                checkboxes.each( function(index, value){sourceUrls.push(value.value)});
                
                // get names
                var sourceNames = [];
                checkboxes.each( function(index, value){sourceNames.push(value.id.replace(/-input$/,''))});
                
                // get types
                var types = []
                checkboxes.each( function(index,value){ types.push( checkboxes[index].getAttribute('data-type') ); } );
                
                var trackOptions = [];
                for(var i=0; i< sourceNames.length; i++){
                   var expandOption = sourceNames[i] + '-expand-option';
                   
                   // check if source is being displayed
                   var menu = document.getElementById(expandOption);
                   if (menu)
                     trackOptions.push(menu.children[0].innerHTML)
                  else
                     trackOptions.push('none');
                }                
                
                // get min, max, chromosome
                var min = $('#slider-range').slider('values',0);
                var max = $('#slider-range').slider('values',1);
                var chr = $('#chromosome').val();
                
                // construct query string
                var queryStr = "?"
                queryStr += "urls=" + sourceUrls.join(',');
                queryStr += "&names=" + sourceNames.join(',');
                queryStr += "&min=" + min;
                queryStr += "&max=" + max;
                queryStr += "&display=" + trackOptions.join(',');
                queryStr += "&segment=" + chr;
                queryStr += "&types=" + types.join(',');
                
                return (getBaseURL() + queryStr);                               
             }
             
             function enableControls() {
                $('button').each( function(index, button){ $(button).button('option','disabled', false) });
                $('input').each( function(index, input){ input.disabled = false});
                $("#scaleSlider").slider('enable');
                $("#shapeSlider").slider('enable');               
                $("#trackSlider").slider('enable');
                $('#text').attr('disabled', false);
             }
             
             function selectAllFeatures() {
                delete selected;
                selected = [];
                
                var selecting;
                
                if( document.getElementById('selectAll').checked )
                  selecting = true;
                else
                  selecting = false;
                  
                for (var i=0; i < mainChart.tracks.length; i++) {
                   for (var k=0; k< mainChart.tracks[i].lanes.length; k++) {
                      for (var j=0; j < mainChart.tracks[i].lanes[k].features.length; j++)
                         selectFeature( mainChart.tracks[i].lanes[k].features[j], selecting);
                   }
                }
             }
             
             function getBaseURL() {
                 var url = location.href;  // entire url including querystring - also: window.location.href;
                 var baseURL = url.split('?')[0]
                 return baseURL;
             }
             
             
             function loadUrlQuery() {
                //parse url querys (if any)
                var querys = getUrlQuerys();                                                
                
                if (querys != "" && Object.keys(querys).length > 0 && Object.keys(querys)[0] != "" ) {
                   enableControls();                    
                  
                   // parse query
                   var urls = querys['urls'].split(',');
                   var names = querys['names'].split(',');
                   var types = querys['types'].split(',');
                   var displays = querys['display'].split(',');
                   var chr = querys['segment'];
                   var min = parseInt(querys['min']);
                   var max = parseInt(querys['max'])
                   
                   // get Das sources                   
                   for (var k=0; k < names.length; k++) {
                      if (displays[k] == 'Expand' || displays[k] == 'Collapse'){
                         activeSeqs++;                     
                         getDas(names[k], urls[k], chr, types[k], min, max, displays[k]);
                      }
                   }
                   
                   $('#scriblAnnotation').css('z-index', 4);

               } else {
                  initDropbox();
               }
             }
             
             function initDropbox() {
                var dropbox = document.getElementById('dropbox');
          		if (!window.FileReader) {
          		  dropbox.innerHTML = "<p>This browser doesnt support the File API</p>";
          		} else {
          		  // Page Layout

          		  dropbox.innerHTML ="<p>Drag a Genbank(.gb) or BED(.bed) file onto this area <input type='hidden' id='file' /><br/>or<br/>Import data from <a href='http://chmille4.github.com/Rover/rover.html'>Rover</a></p>";

          		  // Displays gene charts.
          		  function displayChart(file) {
          		    var reader = new FileReader();
          			var fileType = /[^.]+$/.exec(file.name);

          		   reader.onload = function(event) {
          		      mainChart.laneSizes = 13;
          				if (fileType == "bed") {
          					mainChart.loadBed(event.target.result);
          					enableControls();
          				} else if (fileType == "gb") {
          					mainChart.loadGenbank(event.target.result);
          					enableControls();
          				} else
          				 	alert("File must have a .gb or .bed extension");
          				dropbox.style.display = 'none';
          				mainChart.draw();		
          		    };
          		    reader.readAsText(file);
          		  }		 

          		  // Input handler
          		  document.getElementById('file').onchange = function() {
          		    displayFile(this.files[0]);
          		  };

          		  // Reduce movement by adding invisible border
          		  dropbox.style.border = '4px solid transparent';

          		  // Add dragging events
          		  dropbox.ondragenter = function() {
          		    dropbox.style.border = '4px solid #b1ecb3';
          		    return false;
          		  };

          		  dropbox.ondragover = function() {
          		    return false;
          		  };

          		  dropbox.ondragleave = function() {
          		    dropbox.style.border = '';
          		    return false;
          		  };

          		  dropbox.ondrop = function(event) {
          		    dropbox.style.border = '4px solid transparent';
          		    displayChart(event.dataTransfer.files[0]);
          		    return false;
          		  };
          		}
             }

    		</script>

</head> 
     
<body> 
     
    <div id="content"> 
       
       <div id="title">Figure Maker 1.0</div>
       <div id='main'>
          
          <div id="left-controls">
             <div id="annotationControls" class="side-control">
                <div class="title">Annotation Options</div>
                <div id="commands"> 
                    <div class='field'><button disabled='true' id="add-text">Add text</button></div> 
                    <div class='field'><button disabled='true' id="remove-selected">Remove</button></div> 
                </div>
                <div class="field">Annotation Text</div>
                <textarea disabled='true' placeholder='type here' id="text"></textarea>
                
                
             </div>
             
          </div>         
          
          <div id="right-controls">
                <div id="scaleControls" class="side-control">
                   <div class="title">Chart Options</div>
                   <div><div class="field">Show Scale</div> <input disabled='true' id="scaleShow" type="checkbox" checked="true"/></div>
                   <span class="field">Scale Size</span>
                   <span id="scaleSlider" class="slider"></span>

                   <span class="field">Lane Size</span>
                   <div id="trackSlider" class ="slider"></div>
                </div>
                
                <div id="sliderControls" class="side-control">
                  <div class="title">Feature Options</div>
                  <div><div class="field">Select All</div> <input disabled='true' id="selectAll" type="checkbox"/></div>
                  <span class="field">Shape</span>
                  <div id="shapeSlider" class="slider"></div>
                  <div><span class="field">Color 1</span>
                  <input id="color1" type="color" value="rgb(155,193,255)"/></div>
                  <span class="field">Color 2</span>
                  <input id="color2" type="color" value="rgb(63,128,205)" />
               </div>

               <div id="export" class="side-control">
                  <span class="title">Export As</span><br/>
                  <span class="field"><button id='image-export' disabled='true' onClick="exportImage()">Image</button></span>                 
               </div>
          </div>
  
          <div id='canvasHolder'>
                <div id="canvasList">                   
                   <canvas style="left: 7.5px;" class='canvas' id='canvas'></canvas>
                   <canvas style="left: 7.5px; margin-left: 7.5px" height='410' class='canvas' id='scriblAnnotation'></canvas>                                      

                   <div id='dropbox'></div>
                </div>               
          </div>
       
       
    </div> 
    
    <div id="footer">
      <div style="width=30%;margin-left:auto; margin-right:auto; margin-top: 10px">
         Powered By <a href="http://chmille4.github.com/Scribl/">Scibl</a>
      </div>
      <div style="float:right; margin-right:20px; margin-top:-6px">&copy; <a href="http://github.com/chmille4">Chase Miller</a> 2011</div>
    </div> 
    
       <script src="js/demo.js" type="text/javascript"></script> 
</body> 

</html>
<!DOCTYPE HTML>
<html lang="en"> 

<head> 

   <title></title> 
   <script src="js/Scribl.1.1.2.min.js"></script>         	
   <script src="js/jquery.min.js"></script>
   <script src="js/jquery-ui.chase.min.js"></script>
   <script src="js/colorpicker.js"></script>
   <!-- <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/> -->
   <link href='http://fonts.googleapis.com/css?family=Amaranth:bold' rel='stylesheet' type='text/css'>
   <!-- <link href='http://fonts.googleapis.com/css?family=Gruppo' rel='stylesheet' type='text/css'> -->
   <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.13.redmond.css" />
   <link rel="stylesheet" type="text/css" href="css/figure-builder.css" />
   <link href="css/colorpicker.css" rel="stylesheet" type="text/css" media="all">
   
   <script src="js/jsdas.0.1.6.js" ></script>
   <script src="js/fabric.js"></script> 
   <script src="js/Delicious_500.font.js"></script>   
    
    <script type="text/javascript">    
            var activeSeqs = 0;
    		   var mainChart;	  
    		   var selected = []; 
    		   var fabricCanvas;
    		   
    		   // Object.keys polyfill for older browsers
            Object.keys=Object.keys||function(o,k,r){r=[];for(k in o)r.hasOwnProperty.call(o,k)&&r.push(k);return r}

    		   $(document).ready(function() {
               var canvas = document.getElementById('canvas');               
               canvas.width = getCanvasWidth();               
               document.getElementById('canvasList').width = getCanvasWidth()+20;               
              // alert(canvas.width);
               mainChart = new Scribl(canvas, getChartWidth());
               mainChart.glyph.onClick = function(feature) {selectFeature(feature); redraw();};
               mainChart.lanesSizes = 13;
               $("button").button(); 

               $("#scaleSlider").slider( { min: 3, max: 30, value: 15, slide: function(event, ui){ redraw('scaleSize') } });
               $("#scaleSlider").slider('disable');
          		$("#shapeSlider").slider( { min: 1, max: 20, value: 6, slide: function(event, ui){ redraw('featureShape') } });
          		$("#shapeSlider").slider('disable');
          		$("#trackSlider").slider( { min: 1, max: 200, value: 13, slide: function(event, ui){ redraw('laneSize') } });
          		$("#trackSlider").slider('disable');
               // $('#color1').bind('colorpicked', function () { redraw('color1'); });
               // $('#color2').bind('colorpicked', function () { redraw('color2'); });
               $('#color1').ColorPicker({
                   onSubmit: function(hsb, hex, rgb, el, parent) {
                       $(el).val(hex);
                       $(el).ColorPickerHide();
                       $(el).css('background-color', '#' + hex);
                   },
                   onBeforeShow: function () {
                       $(this).ColorPickerSetColor(this.value);
                   },
                   onChange: function(hsb, hex, rgb){
                       redraw('color1', '#'+hex);
                   }
               })
               .bind('keyup', function(){
                   $(this).ColorPickerSetColor(this.value);
               });
               $('#color2').ColorPicker({
                   onSubmit: function(hsb, hex, rgb, el, parent) {
                       $(el).val(hex);
                       $(el).ColorPickerHide();
                       $(el).css('background-color', '#' + hex);
                   },
                   onBeforeShow: function () {
                       $(this).ColorPickerSetColor(this.value);
                   },
                   onChange: function(hsb, hex, rgb){
                       redraw('color1', '#'+hex);
                   }
               })
               .bind('keyup', function(){
                   $(this).ColorPickerSetColor(this.value);
               });               
               
               $('#scaleShow').bind('click', function () { redraw(); });
               $('#selectAll').bind('click', function () { selectAllFeatures(); redraw(); });
               $('#scriblAnnotation').bind('click', function (e) { 
                  var event = jQuery.Event("click");
                  event.clientX = e.clientX;
                  event.clientY = e.clientY;
                  $('#canvas').trigger(event) 
               });
               loadUrlQuery();            
    		   });


            function selectFeature(feature, selecting) {
               var index = $.inArray(feature, selected)
               
               // select if not already selected
               if ( (selecting == undefined && index == -1) || selecting ) {
                  // set options to selected
                  if (selected.length == 0){
                 //    $("#shapeSlider").slider('value', feature.getRoundness());
                  }
                  selected.push(feature)
                  feature.borderColor = 'rgba(195,38,35,0.6)';
                  feature.borderWidth = 5;
               } else { // deselect if already selected
                  selected.splice(index, 1);
                  feature.borderColor = 'none';
               }
            }
            
            function selectScriblObjects(tlX, tlY, brX, brY) {
               for ( var i=0; i < mainChart.tracks.length; i++ ) {
                  for ( var k=0; k < mainChart.tracks[i].lanes.length; k++ ) {
                     for ( var j=0; j < mainChart.tracks[i].lanes[k].features.length; j++ ) {
                        var f = mainChart.tracks[i].lanes[k].features[j];
                        if ( f.isContainedWithinRect(tlX, tlY, brX, brY) )
                           selectFeature(f, true);
                     }
                  }
               }
            }

            function draw() {
               // turn loading spinner off
               $('#spinner-div').css('display', 'none');
               
               mainChart.canvas.width = getCanvasWidth();
               mainChart.laneSizes = 13;
               mainChart.canvas.height = mainChart.getHeight();

               if ($('#canvas').height() > 410) fabricCanvas.setHeight($('#canvas').height());
               document.getElementById('canvasList').width = getCanvasWidth()+20;
               mainChart.draw();
            }
       		function getDas(name, source, chromosome, type, min, max, display) {
    
       				// get DAS data
       				var url = source + '/features?segment=' + chromosome + ':' + min + "," + max + ';type=' + type;   				
                  // if(display == "Expand")
                  //    JSDAS.features(url, function(response) { addFeatures(response, "Expand") });
                  // else
       				JSDAS.features(url, function(response) { addFeatures(response, display) });

            }  
            
            function getJson(name, source, chromosome, type, min, max, display) {
               var url = source + '?segment=' + chromosome + '&min='  + min + "&max=" + max;     
               var xhr = new XMLHttpRequest();
               xhr.open('GET', url);
               xhr.onreadystatechange = function () {
                 if (this.status == 200 && this.readyState == 4) {
                   addJsonFeatures(this.responseText, display);
                 }
               };
               xhr.send();
               
            }
             
            function exportImage() {
               var canvas = document.createElement('canvas'); 
               var ctx = canvas.getContext("2d");
               
               var chartCanvas = document.getElementById('canvas');
               var annotationCanvas = document.getElementById('scriblAnnotation');
               canvas.width =annotationCanvas.width;
               if (chartCanvas.height > annotationCanvas.height)
                  canvas.height =chartCanvas.height; 
               else 
                  canvas.height =annotationCanvas.height; 
               
               
                ctx.drawImage(chartCanvas, 0,0);
                fabricCanvas.renderAll(true);
                ctx.drawImage(fabricCanvas.upperCanvasEl, 0,0);
               var img = canvas.toDataURL('png');
               window.open(img);
            }

    		   function addFeatures(response, display) {
    		      // set width again in case window wasn't loaded completely
               mainChart.width = getChartWidth();
               var track;
               // if (display == 'Expand')
                  track = mainChart.addTrack();
                  track.drawStyle = display;
               // else
               //    track = mainChart.addTrack().addLane();

    				var features = response.GFF.SEGMENT[0].FEATURE;
                if (!features) {
                   // TODO add an error fetching message
                   return; 
                }
               features.sort( function(a,b){ return(parseInt(a.START.textContent) - parseInt(b.START.textContent)); });
    				for (var i=0; i < features.length; i++) {
    					var f = features[i];
    					var start = parseInt(f.START.textContent);
    					var length =  parseInt(f.END.textContent) - start;
    					if (f.ORIENTATION) {
    						orientation =  f.ORIENTATION.textContent;
    						var glyph = track.addGene(start, length, orientation);
    					} else
    						var glyph = track.addFeature( new Rect( "rect", start, length) );
                     
    					if (f.TYPE.textContent) glyph.name = f.TYPE.textContent;
    					if(f.LINK && f.LINK[0] && f.LINK[0].href) { 
    						//glyph.onMouseover = f.TYPE.textContent + "\n" + f.LINK[0].textContent || f.LINK[0].href;
    						//glyph.onClick = f.LINK[0].href.replace(":8080", "");
    					}
    				}
    				
    				activeSeqs--;
    				if(activeSeqs == 0)
    				   draw();

    			}
    			
    			function addJsonFeatures(recordsStr, display){
    			   // set width again in case window wasn't loaded completely
               mainChart.width = getChartWidth();
               var track;
               // if (display == 'Expand')
                  track = mainChart.addTrack();
                  track.drawStyle = display;

               //    //track = mainChart.addTrack().addLane();

                              if(recordsStr[0] != '[') {
                                 recordsStr = '[' + recordsStr;
                                 recordsStr = recordsStr.replace(/,\s*$/,']');
                              }
               
                              // add new tracks and set default drawStyle
                              //var track = mainChart.addTrack();    // here refers to Scribl::Track not Rover::Track
               
                              var records = jQuery.parseJSON(recordsStr);
               
                              for (var i=0; i < records.length; i++){
                                  // get record data
                                  var fullSeq = records[i]['queryBases'];
                                  var position = records[i]['position'];
                                  var orientation = undefined;
                                  var opts = [];
               
                                  // for bam records only
                                  var cigar = records[i]['cigar'];
               
                                  // for vcf records only
                                  var alt = records[i]['alt'];
               
                                  // bam specific data
                                  // expand cigar while deleting insertions
                                  if (cigar) { 
                                     orientation = '+';
                                     var re = /\d+[A-Z]/g;
                                     var seq = "";
                                     var insertions = [];
                                     var pos = 0;       
                                     var softClipping = 0;  
                                     for(var k=0; k< cigar.length; k++){
                                        var op = parseInt(cigar[k].match(/\d+/)[0]);
                                        var opLtr = cigar[k].match(/[A-Z]/)[0];
                                        if (opLtr == 'M') {
                                           seq += fullSeq.slice(pos,pos+op);
                                           pos += op;
                                        }
                                        else if (opLtr == 'D') 
                                           for(var j=0; j<op; j++) { seq += '-'; }                   
                                        else if (opLtr == 'N') {
                                           for(var j=0; j<op; j++) { seq += 'N'; }
                                           var h = 1;
                                        }
                                        else if (opLtr == 'I') {
                                           insertions.push( {'pos':pos-softClipping, 'seq':fullSeq.slice(pos,pos+op)} );
                                           pos += op;
                                        }
                                        else if (opLtr == 'S' && pos == 0) {
                                          softClipping = op;
                                          pos += op;
                                        }
               
                                     }
                                     opts['insertions'] = insertions;
                                     opts['seq'] = seq;
                                     opts['color'] = 'red';
                                  } else if (alt) { // vcf specific data
                                     opts['seq'] = alt;
                                     opts['ref'] = records[i]['ref'];
                                     if(records[i]['info'] && records[i]['info']['AF']){
                                       opts['fraction'] = records[i]['info']['AF'];
                                    }
                                  }
               
                                  // add feature
                                  var ft;
               
                                  if (insertions && insertions[0] && insertions[0]['seq']) {   
                                     if (orientation)
                                       ft = new BlockArrow( 'bam', position, opts['seq'].length, orientation, opts );
                                     else
                                       ft = new Rect( 'bam', position, opts['seq'].length, opts );
                                     for (var j=0; j< insertions.length; j++) {
                                        var offset = insertions[j]['seq'].length/2;
                                        ft.addTooltip(insertions[j]['seq'],'below', 0, {'ntOffset': insertions[j]['pos']-offset});
                                     }
                                  }
                                  else {
                                     if (orientation)
                                       ft = new BlockArrow( 'bam', position, opts['seq'].length, '+', opts );         
                                     else
                                       ft = new Rect( 'bam', position, opts['seq'].length, opts );
                                  }
               
                                  if(alt)
                                    ft.addTooltip("Ref:"+opts['ref'] + "   Alt:" + opts['seq'] + ":" + opts['fraction'], 'below');
               
                                  track.addFeature( ft );
                               }
               
               activeSeqs--;
               if(activeSeqs == 0)
                  draw();
    			}
    
             
             function redraw(option, hex) {
    				// changeable options    				
    				var roundness = $("#shapeSlider").slider( "option", "value" );
    				var laneSizes = $("#trackSlider").slider( "option", "value" );
    				var scaleSize = $("#scaleSlider").slider( "option", "value" );
    				var canvas = document.getElementById('canvas');
    				canvas.height = mainChart.getHeight() + 20;
    				
               if(!$('#scaleShow').attr('checked'))
    				   mainChart.scale.off = true;
    				else
                  mainChart.scale.off = false;    				

            	// assemble color
            	if(option == 'color1') {
            	   top_color = hex;
       				bottom_color = $('#color2').val();       				
            	} else if (option == 'color2') {
       				top_color = $('#color1').val();
       				bottom_color = hex;            	   
            	} else {
       				top_color = $('#color1').val();
       				bottom_color = $('#color2').val();
       			}
               
               //  set new chart values
               mainChart.laneSizes = parseInt(laneSizes);
               mainChart.scale.font.size = scaleSize;
               
                  $.each(selected, function(index, feature) { if (option == 'featureShape') feature.roundness = roundness;});
                  $.each(selected, function(index, feature) { 
                     if (option == 'color1' || option == 'color2')
                        feature.setColorGradient(top_color, bottom_color);
                  });

    				mainChart.redraw();
    			}

             function getCanvasWidth(){return($(window).width() * .59);}
             function getChartWidth(){return ($(window).width() * .59 - 46); }

             function getUrlQuerys(){
                // get the current URL
                 var url = window.location.toString();
                 url = url.replace('#', '');
                 //get the parameters
                 url.match(/\?(.+)$/);
                 var params = RegExp.$1;
                 // split up the query string and store in an
                 // associative array
                 var params = params.split("&");
                 var queryStringList = {};

                 for(var i=0;i<params.length;i++) {
                     var tmp = params[i].split("=");
                     queryStringList[tmp[0]] = unescape(tmp[1]);
                 }
                 return (queryStringList);
             }
             
             function serializeToIframe() {
                var iframeStr = '<iframe width="500" height="315" style="border:1px solid rgb(220,220,220); border-radius: 4px" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="';
                iframeStr += serializeToUrl();
                iframeStr += '&embed=true"'
                iframeStr += '></iframe>';
                iframeStr += '<br/><small>Powered by <a href="http://bioinformatics.bc.edu/marthlab/Scribl" style="color:#0000FF;text-align:left">Scribl</a></small>';
                return iframeStr;
             }
             
             function serializeToUrl() {
                var checkboxes = $('#source-list').find('input');
                                
                // get urls
                var sourceUrls = [];
                checkboxes.each( function(index, value){sourceUrls.push(value.value)});
                
                // get names
                var sourceNames = [];
                checkboxes.each( function(index, value){sourceNames.push(value.id.replace(/-input$/,''))});
                
                // get types
                var types = []
                checkboxes.each( function(index,value){ types.push( checkboxes[index].getAttribute('data-type') ); } );
                
                var trackOptions = [];
                for(var i=0; i< sourceNames.length; i++){
                   var expandOption = sourceNames[i] + '-expand-option';
                   
                   // check if source is being displayed
                   var menu = document.getElementById(expandOption);
                   if (menu)
                     trackOptions.push(menu.children[0].innerHTML)
                  else
                     trackOptions.push('none');
                }                
                
                // get min, max, chromosome
                var min = $('#slider-range').slider('values',0);
                var max = $('#slider-range').slider('values',1);
                var chr = $('#chromosome').val();
                
                // construct query string
                var queryStr = "?"
                queryStr += "urls=" + sourceUrls.join(',');
                queryStr += "&names=" + sourceNames.join(',');
                queryStr += "&min=" + min;
                queryStr += "&max=" + max;
                queryStr += "&display=" + trackOptions.join(',');
                queryStr += "&segment=" + chr;
                queryStr += "&types=" + types.join(',');
                
                return (getBaseURL() + queryStr);                               
             }
             
             function enableControls() {
                $('button').each( function(index, button){ $(button).button('option','disabled', false) });
                $('input').each( function(index, input){ input.disabled = false});
                $("#scaleSlider").slider('enable');
                $("#shapeSlider").slider('enable');               
                $("#trackSlider").slider('enable');
                $('#text').attr('disabled', false);
             }
             
             function selectAllFeatures() {
                delete selected;
                selected = [];
                
                var selecting;
                
                if( document.getElementById('selectAll').checked )
                  selecting = true;
                else
                  selecting = false;
                  
                for (var i=0; i < mainChart.tracks.length; i++) {
                   for (var k=0; k< mainChart.tracks[i].lanes.length; k++) {
                      for (var j=0; j < mainChart.tracks[i].lanes[k].features.length; j++)
                         selectFeature( mainChart.tracks[i].lanes[k].features[j], selecting);
                   }
                }
             }
             
             function getBaseURL() {
                 var url = location.href;  // entire url including querystring - also: window.location.href;
                 var baseURL = url.split('?')[0]
                 return baseURL;
             }
             
             
             function loadUrlQuery() {
                //parse url querys (if any)
                var querys = getUrlQuerys();                                                
                
                if (querys != "" && Object.keys(querys).length > 0 && Object.keys(querys)[0] != "" ) {
                   // turn on loading spinner
                   $('#spinner-div').css('display', 'inherit');
                   
                   // ungray controls
                   enableControls();                    
                  
                   // parse query
                   var urls = querys['urls'].split(',');
                   var names = querys['names'].split(',');
                   var types = querys['types'].split(',');
                   var displays = querys['display'].split(',');
                   var chr = querys['segment'];
                   var min = parseInt(querys['min']);
                   var max = parseInt(querys['max']);
                   
                   // get Das sources                   
                   for (var k=0; k < names.length; k++) {
                      var display = displays[k].toLowerCase();
                      if (display == 'expand' || display == 'collapse' || display == 'line'){
                         activeSeqs++;                 
                         if( /json/.exec(urls[k]) )    
                           getJson(names[k], urls[k], chr, types[k], min, max, display);
                         else
                           getDas(names[k], urls[k], chr, types[k], min, max, display);
                      }
                   }
                   
                   $('#scriblAnnotation').css('z-index', 4);

               } else {
                  initDropbox();
               }
             }
             
             function initDropbox() {
                var dropbox = document.getElementById('dropbox');
          		if (!window.FileReader) {
          		  dropbox.innerHTML = "<p>This browser doesnt support the File API</p>";
          		} else {
          		  // Page Layout

          		  dropbox.innerHTML ="<p>Drag a Genbank(.gb) or BED(.bed) file onto this area <input type='hidden' id='file' /><br/>or<br/>Import data from <a href='http://bioinformatics.bc.edu/marthlab//Rover/index.html'>Rover</a></p>";

          		  // Displays gene charts.
          		  function displayChart(file) {
          		    var reader = new FileReader();
          			var fileType = /[^.]+$/.exec(file.name);

          		   reader.onload = function(event) {
          		      mainChart.laneSizes = 13;
          				if (fileType == "bed") {
          					mainChart.loadBed(event.target.result);
          					enableControls();
          				} else if (fileType == "gb") {
          					mainChart.loadGenbank(event.target.result);
          					enableControls();
          				} else
          				 	alert("File must have a .gb or .bed extension");
          				dropbox.style.display = 'none';
          				mainChart.draw();		
          		    };
          		    reader.readAsText(file);
          		  }		 

          		  // Input handler
          		  document.getElementById('file').onchange = function() {
          		    displayFile(this.files[0]);
          		  };

          		  // Reduce movement by adding invisible border
          		  dropbox.style.border = '4px solid transparent';

          		  // Add dragging events
          		  dropbox.ondragenter = function() {
          		    dropbox.style.border = '4px solid #b1ecb3';
          		    return false;
          		  };

          		  dropbox.ondragover = function() {
          		     dropbox.style.border = '4px solid #b1ecb3';
          		    return false;
          		  };

          		  dropbox.ondragleave = function() {
          		    dropbox.style.border = '';
          		    return false;
          		  };

          		  dropbox.ondrop = function(event) {
          		    dropbox.style.border = '4px solid transparent';
          		    displayChart(event.dataTransfer.files[0]);
          		    return false;
          		  };
          		}
             }

             function testIE() {
                if (navigator.appName == 'Microsoft Internet Explorer')
                  alert("Figure Maker takes advantage of the latest features on the web and therefore doesn't work with Internet Explorer. Please use Chrome, Safari, or Firefox");
             }
    		</script>

</head> 
     
<body onLoad='testIE()'> 
     
    <div id="content"> 
       
       <div id="title">Figure Maker 1.0</div>
       <div id='main'>
          
          <div id="left-controls">
             <div id="scaleControls" class="side-control">
                <div class="title">Chart Options</div>
                <div><div class="field">Show Scale</div> <input disabled='true' id="scaleShow" type="checkbox" checked="true"/></div>
                <span class="field">Scale Size</span>
                <span id="scaleSlider" class="slider"></span>

                <span class="field">Lane Size</span>
                <div id="trackSlider" class ="slider"></div>
             </div>
             
             <div id="export" class="side-control">
                <span class="title">Export As</span><br/>
                <div class="field"><button id='image-export' disabled='true' onClick="exportImage()">Image</button></div>                 
             </div>
             
          </div>         
          
          <div id="right-controls">
                
                <div id="sliderControls" class="side-control">
                  <div class="title">Feature Options</div>
                  <div><div class="field">Select All</div> <input disabled='true' id="selectAll" type="checkbox"/></div>
                  <span class="field">Shape</span>
                  <div id="shapeSlider" class="slider"></div>
                  <div><span class="field">Color 1</span>
                  <input id="color1" value="rgb(155,193,255)"/></div>
                  <span class="field">Color 2</span>
                  <input id="color2" value="rgb(63,128,205)" />
               </div>
               
               
               <div id="annotationControls" class="side-control">
                  <div class="title">Annotation Options</div>
                  <div id="commands"> 
                      <div class='field'><button disabled='true' id="add-text">Add text</button></div>
                      <div class='field'><button disabled='true' id="remove-selected">Remove</button></div> 
                  </div>
                  <textarea placeholder='type here' id="text" style="position:absolute; left: -999em; overflow:hidden"></textarea>
               </div>
               
          </div>
  
          <div id='canvasHolder'>
                <div id="canvasList">                                      
                   <canvas style="left: 10px" class='canvas' id='canvas'></canvas>                   
                   <canvas style="left: 10px" height='410' class='canvas' id='scriblAnnotation'></canvas>                                      
                   <div id='spinner-div' style='display:none'>
                      <img id ='spinner' src='images/spinner.gif'></img>                      
                      <div>Retrieving sequences from remote sources</div>
                   </div>
                   <div id='dropbox'></div>
                </div>               
          </div>
       
       
    </div> 
    
    <div id="footer">
      <div style="width=30%;margin-left:auto; margin-right:auto; margin-top: 10px">
         Powered By <a href="http://bioinformatics.bc.edu/marthlab/Scribl/">Scribl</a>
      </div>
      <div style="float:right; margin-right:20px; margin-top:-6px">&copy; <a href="http://github.com/chmille4">Chase Miller</a> 2011</div>
    </div> 
    
       <script src="js/demo.js" type="text/javascript"></script> 
</body> 

</html>
